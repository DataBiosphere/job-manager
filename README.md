# Job Manager
_This product is in Alpha and not yet ready for production use. We welcome all feedback!_

See the [development guide](#development) below.

The Job Manager is an API and UI for monitoring and managing jobs in a backend execution engine.

The Broad, Verily, and many other organizations in the life sciences execute enormous numbers of scientific workflows and need to manage those operations. Job Manager was born out of the experiences of producing data for some of the world’s largest sequencing projects such as The Cancer Genome Atlas, Baseline, and the Thousand Genomes Project.

The Job Manager aspires to bring ease and efficiency to developing and debugging workflows while seamlessly scaling to production operations management.

## Key Features
* Supports visualization over [Cromwell](https://github.com/broadinstitute/cromwell) or [dsub](https://github.com/googlegenomics/dsub) backends
* Service provider interface can be extended to support other engines
* Rich search capabilities across current and historic workflows
* Aborting workflows
* Clean, intuitive UX based on material design principles

### Future Features
* Dynamic grouping, filtering, and drill-down
* Re-launching workflows
* Simplified troubleshooting of failed workflows

## Roadmap

The current code is a work in progress towards an alpha release and as such has started with core features: connecting to both backends, visualizing workflow and task status and metadata, quick access to log files, and simple filtering.

The near-term roadmap includes improvements to failure troubleshooting, creating a robust dashboard for grouping jobs and seeing status overviews, and improving handling of widely scattered workflows.

We envision a product with user-customizable views of jobs running, insights into workflow compute cost, the ability to re-launch jobs, and the potential to make custom reports about the jobs that have been run.

## Architecture Overview

The Job Manager [defines an API](api/jobs.yaml) via OpenAPI. An Angular2 UI is provided over the autogenerated Typescript bindings for this API. The UI is configurable at compilation time to support various deployment environments (see [environment.ts](ui/src/environments/environment.ts)), including auth, cloud projects, and label columns.

The UI must be deployed along with a backend implementation of the API; two such implementations are provided here:

### Cromwell
Monitors jobs launched by the [Cromwell workflow engine](https://github.com/broadinstitute/cromwell). The Python Flask wrapper was created using Swagger Codegen and can be configured to pull data from a specific Cromwell instance. The Job Manager currently supports Cromwell version 30.2.

### dsub

Monitors jobs that were launched via the [dsub](https://github.com/googlegenomics/dsub) CLI. Thin stateless wrapper around the dsub Python library. Authorization is required for deploying the UI, which is used to communicate with the [Google Genomics Pipelines API](https://cloud.google.com/genomics/pipelines). The wrapper itself is implemented in Python Flask using Swagger codegen models. A Dockerfile is provided which serves for production deployment using gunicorn.

Note that a “task” in dsub nomenclature corresponds to a Job Manager API’s “job”.

## Development

### Prerequisite
The following commands assume you have symbolically linked your preferred
local API backend docker compose file as `docker-compose.yml`, e.g.:
```
ln -sf dsub-local-compose.yml docker-compose.yml
```
Alternatively, use:
```
docker-compose -f dsub-google-compose.yml CMD
```

### Server Setup
For setting up development with [`dsub`](https://github.com/googlegenomics/dsub)
see [servers/dsub](servers/dsub/README.md#Development).

For setting up development with [`cromwell`](https://github.com/broadinstitute/cromwell)
see [servers/cromwell](servers/cromwell/README.md#Development).


### Run Locally
1. Run `docker-compose up` from the root of the repository:
2. Navigate to http://localhost:4200.

#### Notes
1. Websocket reload on code change does not work in docker-compose (see
https://github.com/angular/angular-cli/issues/6349).
2. Changes to `package.json` or `requirements.txt` or [regenerating the API](#updating-the-api-using-swagger-codegen) require a rebuild with:
  ```
  docker-compose up --build
  ```
  Alternatively, rebuild a single component:
  ```
  docker-compose build ui
  ```

### Updating the API using swagger-codegen
We use [swagger-codegen](https://github.com/swagger-api/swagger-codegen) to automatically implement the API, as defined in `api/jobs.yaml`, for all
servers and the UI. Whenever the API is updated, follow these steps to
update the server implementations:

1. If you do not already have the jar, you can download it here:
    ```
    # Linux
    wget http://central.maven.org/maven2/io/swagger/swagger-codegen-cli/2.2.3/swagger-codegen-cli-2.2.3.jar -O swagger-codegen-cli.jar
    # macOS
    brew install swagger-codegen
    ```
2. Clear out existing generated models:
    ```
    rm ui/src/app/shared/model/*
    rm servers/dsub/jobs/models/*
    rm servers/cromwell/jobs/models/*
    ```
3. Regenerate both the python and angular definitions.
    ```
    java -jar swagger-codegen-cli.jar generate \
      -i api/jobs.yaml \
      -l typescript-angular2 \
      -o ui/src/app/shared
      java -jar swagger-codegen-cli.jar generate \
      -i api/jobs.yaml \
      -l python-flask \
      -o servers/dsub \
      -DsupportPython2=true,packageName=jobs
      java -jar swagger-codegen-cli.jar generate \
      -i api/jobs.yaml \
      -l python-flask \
      -o servers/cromwell \
      -DsupportPython2=true,packageName=jobs
      ```
4. Update the server implementations to resolve any broken dependencies on old API definitions or implement additional functionality to match the new specs.

## Job Manager UI Server
For UI server documentation, see [ui](ui/).

## Job Manager `dsub` Server
For `dsub` server documentation, see [servers/dsub](servers/dsub/README.md).

## Job Manager `cromwell` Server
For `cromwell` server documentation, see [servers/cromwell](servers/cromwell/README.md).
