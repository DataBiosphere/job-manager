<mat-expansion-panel class="content" expanded="true" [disabled]="true" [ngClass]="{'has-tasks' : hasTasks()}" #tabsPanel>
  <mat-tab-group [(selectedIndex)]="selectedTab">
    <mat-tab *ngIf="hasTasks()" label="List View">
      <mat-accordion>
        <mat-expansion-panel disabled="disabled" class="list-header">
          <mat-expansion-panel-header>
            <mat-panel-title><div class="task-name">Task Name</div></mat-panel-title>
            <mat-panel-description>
              <div class="task-status">Status</div>
              <div class="task-start">Start</div>
              <div class="task-duration">Duration</div>
              <div class="task-inputs">Inputs</div>
              <div class="task-outputs">Outputs</div>
              <div class="task-links">Links</div>
              <div class="task-attempts">Attempts</div>
            </mat-panel-description>
          </mat-expansion-panel-header>
        </mat-expansion-panel>
        <ng-container *ngFor="let t of tasks">
          <ng-container *ngIf="t.jobId">
            <mat-expansion-panel disabled="disabled" class="list-row">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <div class="task-name">
                    <a class="title-link" (click)="navigateDown(t.jobId)">{{ t.name }}</a>
                  </div>
                </mat-panel-title>
                <mat-panel-description>
                  <div class="task-status status-icon">
                    <clr-tooltip>
                      <clr-icon clrTooltipTrigger [attr.shape]="getStatusIcon(t.executionStatus)" size="18"></clr-icon>
                      <clr-tooltip-content clrPosition="letitletitleft" clrSize="xs" *clrIfOpen>
                        <span>{{ t.executionStatus }}</span>
                      </clr-tooltip-content>
                    </clr-tooltip>
                  </div>
                  <div class="task-start">
                    <jm-datetime [datetime]="t.start"></jm-datetime>
                  </div>
                  <div class="task-duration">
                    {{ t.start | jmDuration: t.end }}
                    <clr-tooltip *ngIf="t.callCached">
                      <clr-icon clrTooltipTrigger shape="history" size="14" style="color:rgba(0, 0, 0, 0.54)"></clr-icon>
                      <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                        <span>This task was cached</span>
                      </clr-tooltip-content>
                    </clr-tooltip>
                  </div>
                  <div class="task-inputs">
                    <button mat-icon-button *ngIf="hasInputs(t)" [mat-menu-trigger-for]="inputMenu" (click)="$event.stopPropagation()">
                      <clr-tooltip>
                        <clr-icon clrTooltipTrigger shape="import" size="18"></clr-icon>
                        <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                          <span>imports</span>
                        </clr-tooltip-content>
                      </clr-tooltip>
                    </button>
                    <mat-menu #inputMenu="matMenu" class="input-menu" xPosition="after" yPosition="below" [overlapTrigger]="false">
                      <jm-resources-table [entries]="t.inputs" (click)="$event.stopPropagation()"></jm-resources-table>
                    </mat-menu>
                  </div>
                  <div class="task-outputs">
                    <button mat-icon-button *ngIf="hasOutputs(t)" [mat-menu-trigger-for]="outputMenu" (click)="$event.stopPropagation()">
                      <clr-tooltip>
                        <clr-icon clrTooltipTrigger shape="export" size="18"></clr-icon>
                        <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                          <span>imports</span>
                        </clr-tooltip-content>
                      </clr-tooltip>
                    </button>
                    <mat-menu #outputMenu="matMenu" class="input-menu" xPosition="after" yPosition="below" [overlapTrigger]="false">
                      <jm-resources-table [entries]="t.outputs" (click)="$event.stopPropagation()"></jm-resources-table>
                    </mat-menu>
                  </div>
                  <div class="task-links">
                    <jm-debug-icons [displayMessage]="false"
                                    [message]=""
                                    [stdout]="t.stdout"
                                    [stderr]="t.stderr"
                                    [directory]="t.callRoot">
                    </jm-debug-icons>

                  </div>
                  <div class="task-attempts">&nbsp;</div>
                </mat-panel-description>
              </mat-expansion-panel-header>
            </mat-expansion-panel>
          </ng-container>

          <ng-container *ngIf="!t.jobId">
            <mat-expansion-panel *ngIf="!taskIsScattered(t)" class="list-row" expanded="false" (opened)="populateTaskAttempts(t)">
              <mat-expansion-panel-header [expandedHeight]="'48px'">
                <mat-panel-title><div class="task-name">{{ t.name }}</div></mat-panel-title>
                <mat-panel-description>
                  <div class="task-status status-icon">
                    <clr-tooltip>
                      <clr-icon clrTooltipTrigger [attr.shape]="getStatusIcon(t.executionStatus)" size="18"></clr-icon>
                      <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                        <span>{{ t.executionStatus }}</span>
                      </clr-tooltip-content>
                    </clr-tooltip>
                  </div>
                  <div class="task-start">
                    <jm-datetime [datetime]="t.start"></jm-datetime>
                  </div>
                  <div class="task-duration">
                    {{ t.start | jmDuration: t.end }}
                    <clr-tooltip *ngIf="t.callCached">
                      <clr-icon clrTooltipTrigger shape="history" size="14" style="color:rgba(0, 0, 0, 0.54)"></clr-icon>
                      <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                        <span>This task was cached</span>
                      </clr-tooltip-content>
                    </clr-tooltip>
                  </div>
                  <div class="task-inputs">
                    <button mat-icon-button *ngIf="hasInputs(t)" [mat-menu-trigger-for]="inputMenu" (click)="$event.stopPropagation()">
                      <clr-tooltip>
                        <clr-icon clrTooltipTrigger shape="import" size="18"></clr-icon>
                        <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                          <span>imports</span>
                        </clr-tooltip-content>
                      </clr-tooltip>
                    </button>
                    <mat-menu #inputMenu="matMenu" class="input-menu" xPosition="after" yPosition="below" [overlapTrigger]="false">
                      <jm-resources-table [entries]="t.inputs" (click)="$event.stopPropagation()"></jm-resources-table>
                    </mat-menu>
                  </div>
                  <div class="task-outputs">
                    <button mat-icon-button *ngIf="hasOutputs(t)" [mat-menu-trigger-for]="outputMenu" (click)="$event.stopPropagation()">
                      <clr-tooltip>
                        <clr-icon clrTooltipTrigger shape="export" size="18"></clr-icon>
                        <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                          <span>imports</span>
                        </clr-tooltip-content>
                      </clr-tooltip>
                    </button>
                    <mat-menu #outputMenu="matMenu" class="input-menu" xPosition="after" yPosition="below" [overlapTrigger]="false">
                      <jm-resources-table [entries]="t.outputs" (click)="$event.stopPropagation()"></jm-resources-table>
                    </mat-menu>
                  </div>
                  <div class="task-links">
                    <jm-debug-icons [displayMessage]="false"
                                    [message]=""
                                    [stdout]="t.stdout"
                                    [stderr]="t.stderr"
                                    [directory]="t.callRoot">
                    </jm-debug-icons>
                  </div>
                  <div class="task-attempts">
                    {{ t.attempts }}
                  </div>
                </mat-panel-description>
              </mat-expansion-panel-header>
              <jm-attempt [attempt]="attempt" *ngFor="let attempt of t.attemptsData"></jm-attempt>
            </mat-expansion-panel>
            <mat-expansion-panel *ngIf="taskIsScattered(t)" class="list-row" expanded="false" disabled="disabled">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <div class="task-name">
                    <a class="title-link" (click)="navigatetoScatters(t.jobId)">{{ t.name }}</a>
                    <clr-tooltip class="scatter-icon">
                       <clr-icon clrTooltipTrigger shape="layers" size="24" class="is-solid"></clr-icon>
                       <clr-tooltip-content clrPosition="left"  clrSize="xs" *clrIfOpen>
                         <span>task is scattered</span>
                       </clr-tooltip-content>
                     </clr-tooltip>
                  </div>
                 </mat-panel-title>
                <mat-panel-description>
                  <div class="status-icon task-status">
                    <clr-tooltip>
                      <clr-icon clrTooltipTrigger [attr.shape]="getStatusIcon(t.executionStatus)" size="18"></clr-icon>
                      <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                        <span>{{ t.executionStatus }}</span>
                      </clr-tooltip-content>
                    </clr-tooltip>
                  </div>
                  <div class="task-start">
                    <jm-datetime [datetime]="t.start"></jm-datetime>
                  </div>
                  <div class="task-duration">
                    {{ t.start | jmDuration: t.end }}
                    <clr-tooltip *ngIf="t.callCached">
                      <clr-icon clrTooltipTrigger shape="history" size="14" style="color:rgba(0, 0, 0, 0.54)"></clr-icon>
                      <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                        <span>This task was cached</span>
                      </clr-tooltip-content>
                    </clr-tooltip>
                  </div>
                  <div class="task-inputs">
                    <button mat-icon-button *ngIf="hasInputs(t)" [mat-menu-trigger-for]="inputMenu" (click)="$event.stopPropagation()">
                      <clr-tooltip>
                        <clr-icon clrTooltipTrigger shape="import" size="18"></clr-icon>
                        <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                          <span>imports</span>
                        </clr-tooltip-content>
                      </clr-tooltip>
                    </button>
                    <mat-menu #inputMenu="matMenu" class="input-menu" xPosition="after" yPosition="below" [overlapTrigger]="false">
                      <jm-resources-table [entries]="t.inputs" (click)="$event.stopPropagation()"></jm-resources-table>
                    </mat-menu>
                  </div>
                  <div class="task-outputs">
                    <button mat-icon-button *ngIf="hasOutputs(t)" [mat-menu-trigger-for]="outputMenu" (click)="$event.stopPropagation()">
                      <clr-tooltip>
                        <clr-icon clrTooltipTrigger shape="import" size="18"></clr-icon>
                        <clr-tooltip-content clrPosition="left" clrSize="xs" *clrIfOpen>
                          <span>imports</span>
                        </clr-tooltip-content>
                      </clr-tooltip>
                    </button>
                    <mat-menu #outputMenu="matMenu" class="input-menu" xPosition="after" yPosition="below" [overlapTrigger]="false">
                      <jm-resources-table [entries]="t.outputs" (click)="$event.stopPropagation()"></jm-resources-table>
                    </mat-menu>
                  </div>
                  <div class="task-links">
                    <jm-debug-icons [displayMessage]="false"
                                    [message]=""
                                    [stdout]="t.stdout"
                                    [stderr]="t.stderr"
                                    [directory]="t.callRoot">
                    </jm-debug-icons>
                  </div>
                  <div class="task-attempts">&nbsp;</div>
                </mat-panel-description>
              </mat-expansion-panel-header>
            </mat-expansion-panel>
          </ng-container>
        </ng-container>
      </mat-accordion>
    </mat-tab>
    <!-- Task failures tab -->
    <mat-tab *ngIf="hasFailures()" label="Errors">
      <jm-failures-table [failures]="job.failures"
                         [numToShow]="job.failures.length"
                         [showHeaders]="true"
                         [displayedColumns]="['name','message','links']"
                         [context]="'tab'">
      </jm-failures-table>
    </mat-tab>
    <!-- Task inputs tab -->
    <mat-tab *ngIf="hasInputs(job)" label="Inputs">
      <jm-resources-table [entries]="job.inputs"></jm-resources-table>
    </mat-tab>
    <!-- Task outputs tab -->
    <mat-tab *ngIf="hasOutputs(job)" label="Outputs">
      <jm-resources-table [entries]="job.outputs"></jm-resources-table>
    </mat-tab>
    <!-- Task timing diagram tab -->
    <mat-tab *ngIf="hasTasks()" label="Timing Diagram">
      <jm-timing-diagram [metadata]="job.extensions.tasks" [tabWidth]="tabWidth"></jm-timing-diagram>
    </mat-tab>
  </mat-tab-group>
</mat-expansion-panel>
